# Embed System Documentation

## Overview

The RMG Premium Listings embed system allows third-party websites to display listing cards via an iframe that automatically resizes to fit its content. This document explains how the two-way communication works between the parent page and the embedded iframe.

## How It Works

The embed uses the browser's `postMessage` API to communicate between the iframe (child) and the parent page. Due to browser security (same-origin policy), the parent page **cannot directly access** the iframe's content height, so the iframe must **send** its height to the parent.

### The Two Parts

#### 1. Inside the Iframe (embed-listing-cards.php)

**Location**: `templates/embed-listing-cards.php` (lines 55-90)

**Purpose**: Measures the iframe's content height and sends it to the parent page.

```javascript
function sendHeight() {
    const height = document.documentElement.scrollHeight;
    window.parent.postMessage({
        type: 'rmg-embed-resize',
        height: height
    }, '*');
}
```

**Triggers**:
- Initial page load (DOMContentLoaded)
- Window resize events
- DOM changes (via MutationObserver)
- Every 1 second (safety backup)

**Why Multiple Triggers?**:
- **DOMContentLoaded**: Captures initial height when page first loads
- **Resize Events**: Updates when browser window is resized
- **MutationObserver**: Detects when content changes dynamically (sliders, lazy-loaded images, etc.)
- **Interval**: Safety net for edge cases where other triggers might miss

#### 2. On the Parent Page (Embed Code)

**Location**: Generated by `src/js/admin.js` → `generateEmbedCode()` method

**Purpose**: Listens for height messages from the iframe and updates the iframe's height.

```javascript
addEventListener('message', function(e) {
    if (e.data.type === 'rmg-embed-resize') {
        i.style.height = e.data.height + 'px';
    }
});
```

**How It Works**:
1. Listens for all `message` events
2. Filters for messages with `type: 'rmg-embed-resize'`
3. Sets the iframe's height to the received value

## Complete Communication Flow

```
┌─────────────────────────────────────────┐
│         Parent Page (sober.com)         │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │ Message Listener                  │ │
│  │ - Waits for 'rmg-embed-resize'    │ │
│  │ - Updates iframe height           │ │
│  └───────────────────────────────────┘ │
│                 ▲                       │
│                 │ postMessage           │
│                 │ {type, height}        │
│  ┌──────────────┴──────────────────┐  │
│  │ <iframe> rehab.test/embed       │  │
│  │  ┌──────────────────────────┐   │  │
│  │  │ sendHeight()             │   │  │
│  │  │ - Measures scrollHeight  │   │  │
│  │  │ - Sends to parent        │   │  │
│  │  │                          │   │  │
│  │  │ Triggers:                │   │  │
│  │  │ • Page load              │   │  │
│  │  │ • Window resize          │   │  │
│  │  │ • DOM mutations          │   │  │
│  │  │ • Every 1 second         │   │  │
│  │  └──────────────────────────┘   │  │
│  └──────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

## Example Embed Code

Here's what the generated embed code looks like:

```html
<!-- RMG Premium Listings Embed -->
<div id="rmg-premium-listings-embed"></div>
<script>
(function() {
    var u = new URL('https://rehab.test/embed/listing-cards/?config=...');
    u.searchParams.append('parent_url', location.href);
    u.searchParams.append('parent_host', location.hostname);
    u.searchParams.append('parent_referrer', document.referrer);
    u.searchParams.append('parent_title', document.title);

    var i = document.createElement('iframe');
    i.src = u;
    i.style.cssText = 'width:100%;border:none;overflow:hidden';
    i.scrolling = 'no';

    // 👇 This is the parent-side message listener
    addEventListener('message', function(e) {
        if (e.data.type === 'rmg-embed-resize') i.style.height = e.data.height + 'px';
    });

    document.getElementById('rmg-premium-listings-embed').appendChild(i);
})();
</script>
```

## Why This Approach?

### Browser Security (Same-Origin Policy)

Browsers prevent a parent page from accessing content inside an iframe if they're from different domains. This is a security feature to prevent malicious sites from reading sensitive data.

**Without postMessage**, we would have these problems:
- Parent page cannot read `iframe.contentDocument.body.scrollHeight`
- Parent page gets security errors trying to access iframe internals
- No way to auto-size the iframe to fit content

**With postMessage**, we can:
- Iframe sends its own height (it can read its own content)
- Parent page receives the height as a simple message
- Parent page sets the iframe height based on the message
- Works across different domains securely

### Why Not Just Use a Fixed Height?

Fixed height iframes have problems:
- Content might be cut off if iframe is too short
- Wasted space if iframe is too tall
- Doesn't adapt to different screen sizes
- Poor user experience

### Alternative Approaches (Not Used)

**CSS-only solutions don't work for cross-origin iframes:**
- `height: 100%` - Doesn't work without parent having fixed height
- Aspect ratio padding - Requires knowing the exact aspect ratio
- `min-content` / `max-content` - Doesn't work for iframes

**JavaScript library solutions:**
- We could use a library like `iframe-resizer`, but our custom solution is:
  - Smaller (no external dependencies)
  - Simpler (just what we need)
  - More maintainable (we control the code)

## Parent Page Tracking

The embed code also captures parent page information for analytics:

```javascript
u.searchParams.append('parent_url', location.href);
u.searchParams.append('parent_host', location.hostname);
u.searchParams.append('parent_referrer', document.referrer);
u.searchParams.append('parent_title', document.title);
```

This data is passed to the `rmg_impression_tracking_config` filter inside the iframe template (lines 104-131) so that impression tracking can attribute views to the correct parent page.

## Troubleshooting

### Iframe Not Resizing

**Possible Causes:**
1. Message listener not added to parent page
2. `sendHeight()` not being called inside iframe
3. Content height not being measured correctly

**Debug Steps:**
```javascript
// Inside iframe - check if messages are being sent
console.log('Sending height:', document.documentElement.scrollHeight);

// On parent page - check if messages are being received
addEventListener('message', function(e) {
    console.log('Received message:', e.data);
});
```

### Iframe Height Jumps/Flickers

**Cause**: Multiple rapid height changes due to:
- Images loading
- Fonts loading
- Slider animations

**Solution**: The 1-second interval helps stabilize this, but you can also:
- Debounce the `sendHeight()` function
- Set `min-height` on iframe content
- Ensure images have width/height attributes

### Security Warnings

**Cause**: Using `'*'` as target origin in `postMessage`

**Why It's Safe Here**:
- We're only sending public data (height number)
- No sensitive information in the message
- Parent page validates message type before acting

**Production Improvement** (optional):
```javascript
// Instead of '*', specify actual parent origin
window.parent.postMessage({
    type: 'rmg-embed-resize',
    height: height
}, 'https://sober.com'); // Specific origin
```

## Related Files

- `templates/embed-listing-cards.php` - Iframe template with `sendHeight()` logic
- `src/js/admin.js` - Generates embed code with message listener
- `inc/class-embed.php` - Handles the `/embed/listing-cards/` endpoint
- `inc/admin/views/settings-page.php` - Admin UI for generating embeds

## Filter Hooks

### `rmg_impression_tracking_config`

Applied in `embed-listing-cards.php` (line 104-131) to pass parent page data to impression tracking:

```php
add_filter('rmg_impression_tracking_config', function($config) {
    $config['parentUrl']      = $_GET['parent_url'] ?? '';
    $config['parentHost']     = $_GET['parent_host'] ?? '';
    $config['parentReferrer'] = $_GET['parent_referrer'] ?? '';
    $config['parentTitle']    = $_GET['parent_title'] ?? '';
    $config['isAdminPreview'] = (strpos($config['parentUrl'], '/wp-admin/') !== false);
    return $config;
});
```

This allows the impression tracking plugin to:
- Attribute impressions to the correct referring site
- Detect admin preview vs live embed
- Track which pages are using the embed

## Performance Considerations

**Minimal Overhead**:
- `postMessage` is very fast (microseconds)
- Height calculation is simple DOM property read
- Message listener only fires when needed
- Interval-based update (1 second) is negligible

**Optimization Opportunities**:
- Could debounce MutationObserver to reduce message frequency
- Could use IntersectionObserver to only update when visible
- Could remove interval if other triggers are reliable enough
